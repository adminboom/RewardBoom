<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>exchangeReward - System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #0b0e14; color: #f1f5f9; }
        .glass-card { background: #111827; border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 2rem; }
        .total-glow { 
            text-shadow: 0 0 50px rgba(59, 130, 246, 0.9), 0 0 100px rgba(59, 130, 246, 0.5); 
        }
        [x-cloak] { display: none !important; }
        .sidebar-active { background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0) 100%); border-left: 4px solid #3b82f6; color: #3b82f6 !important; }
    </style>
</head>
<body x-data="system()">

    <template x-if="currentPage === 'login'">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="glass-card w-full max-w-md p-10 shadow-2xl text-center">
                <div class="bg-orange-600 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-orange-900/40">
                    <span class="text-3xl text-white">üîê</span>
                </div>
                <h2 class="text-3xl font-black italic text-white tracking-tight uppercase">EXCHANGE REWARD</h2>
                <div class="space-y-4">
                    <input type="password" x-model="passInput" placeholder="PASSWORD" class="w-full bg-[#0b0e14] border border-white/10 rounded-2xl px-4 py-4 focus:outline-none focus:ring-1 focus:ring-orange-500 text-white text-center font-bold tracking-[0.5em]">
                    <button @click="doLogin" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-black py-4 rounded-2xl shadow-xl shadow-orange-900/40 transition-all uppercase italic">Login System</button>
                    <button @click="currentPage = 'home'" class="w-full py-2 text-gray-600 text-[10px] hover:text-white transition-colors uppercase tracking-widest font-bold text-center">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                </div>
            </div>
        </div>
    </template>

    <template x-if="currentPage === 'admin'">
        <div class="min-h-screen p-8 max-w-5xl mx-auto">
            <header class="flex justify-between items-center mb-12">
                <div class="flex items-center space-x-4 text-orange-600"><h1 class="text-2xl font-black italic tracking-tight uppercase">ADMIN PANEL</h1></div>
                <button @click="logout" class="bg-white/5 border border-white/10 px-6 py-2 rounded-full text-xs font-bold hover:bg-red-600">‚ûú Logout</button>
            </header>
            <div class="space-y-8">
                <div class="glass-card p-10 border-orange-500/20">
                    <h3 class="font-bold mb-6 text-orange-400 uppercase tracking-widest text-sm">Database Config</h3>
                    <input type="text" x-model="csvUrl" class="w-full bg-[#0b0e14] border border-white/10 rounded-xl px-5 py-4 text-xs font-mono text-gray-400 mb-4">
                    <button @click="saveUrl" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-black py-5 rounded-2xl transition-all uppercase italic tracking-widest">Update Database</button>
                </div>
                <div class="glass-card p-10 border-emerald-500/20 shadow-2xl bg-emerald-500/[0.02] flex justify-between items-center">
                    <div><p class="text-sm font-bold text-white mb-1">Google Sheets Editor</p><p class="text-xs text-gray-500 italic">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏á‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</p></div>
                    <a href="https://docs.google.com/spreadsheets/d/1fPWt2t4zumgImIgoBWLMyIBO-8YR19eOoCaJzbl3jNw/edit#gid=0" target="_blank" class="bg-emerald-600 hover:bg-emerald-500 text-white px-8 py-4 rounded-xl font-black text-sm uppercase transition-all">üåê ‡πÄ‡∏õ‡∏¥‡∏î‡∏ä‡∏µ‡∏ó</a>
                </div>
            </div>
        </div>
    </template>

    <template x-if="currentPage === 'home'">
        <div class="flex h-screen overflow-hidden">
            <aside class="w-72 bg-[#111827] border-r border-white/5 flex flex-col shadow-2xl z-20">
                <div class="p-8">
                    <h2 class="text-2xl font-black text-blue-500 italic tracking-tighter uppercase leading-none">EXCHANGE<br>REWARD</h2>
                </div>
                <nav class="flex-1 px-4 py-4 space-y-2 overflow-y-auto uppercase">
                    <template x-for="box in rewardData" :key="box.id">
                        <button @click="changeTab(box.id)" 
                            :class="activeTab === box.id ? 'sidebar-active text-blue-400' : 'text-gray-500 hover:bg-white/5'"
                            class="w-full flex flex-col px-5 py-4 text-sm rounded-xl transition-all duration-300">
                            <div class="flex justify-between w-full mb-1">
                                <span class="text-[10px] font-bold opacity-40 uppercase" x-text="box.id"></span>
                                <span class="text-[10px] font-black italic text-gray-400" x-text="box.total"></span>
                            </div>
                            <div class="text-left truncate w-full font-bold uppercase tracking-tight" x-text="box.title"></div>
                        </button>
                    </template>
                </nav>
            </aside>

            <main class="flex-1 flex flex-col bg-[#0b0e14]">
                <header class="bg-[#111827] px-8 py-5 flex justify-between items-center border-b border-white/5 shadow-xl z-30 uppercase font-bold">
                    <h1 class="text-lg font-bold text-white italic tracking-tight" x-text="getCurrentBox()?.title || 'Syncing...'"></h1>
                    <div class="flex items-center space-x-4">
                        <input type="text" x-model="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="bg-[#0b0e14] border border-white/10 rounded-full pl-6 pr-6 py-2 text-xs text-white w-64">
                        <button @click="currentPage = 'login'" class="bg-blue-600/10 text-blue-500 px-4 py-2 rounded-full text-[10px] font-black tracking-widest border border-blue-500/20 hover:bg-blue-600 hover:text-white transition-all">üîí ADMIN</button>
                    </div>
                </header>

                <section class="flex-1 p-8 overflow-y-auto space-y-8 scroll-smooth">
                    
                    <div class="w-full bg-gradient-to-br from-blue-600 via-blue-700 to-indigo-900 rounded-[3rem] p-16 flex flex-col md:flex-row justify-between items-center relative overflow-hidden shadow-2xl border border-white/10">
                        <div class="absolute -right-10 -bottom-10 text-[25rem] opacity-10 font-black italic pointer-events-none tracking-tighter uppercase select-none">TOTAL</div>
                        <div class="z-10 text-center md:text-left">
                            <h2 class="text-white text-6xl font-black italic tracking-tighter uppercase leading-tight" x-text="getCurrentBox()?.title"></h2>
                            <p class="text-[12px] text-blue-200 uppercase font-black tracking-[0.5em] mt-6 opacity-60">‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏£‡∏≠‡∏ö</p>
                        </div>
                        <div class="text-center md:text-right z-10">
                            <span class="text-[14rem] font-black text-white total-glow tracking-tighter block leading-none" x-text="getCurrentBox()?.total.toLocaleString() || 0"></span>
                            <span class="text-blue-100 font-black uppercase text-[16px] tracking-[0.8em] italic opacity-80 mt-4 block">Redeems Collected</span>
                        </div>
                    </div>

                    <div class="glass-card overflow-hidden shadow-2xl border-white/5">
                        <table class="w-full text-left">
                            <thead class="bg-white/[0.03] border-b border-white/5 uppercase tracking-[0.4em] text-[10px] font-black text-gray-500">
                                <tr><th class="px-10 py-6 italic">Reward List ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡∏£‡∏±‡∏ö</th><th class="px-10 py-6 text-center italic font-black text-blue-400">Collected</th></tr>
                            </thead>
                            <tbody class="divide-y divide-white/5">
                                <template x-for="item in filteredItems()" :key="item.name + item.sys">
                                    <tr class="hover:bg-blue-500/[0.04] transition-colors group">
                                        <td class="px-10 py-6">
                                            <div class="text-sm font-bold text-gray-200 group-hover:text-blue-400 transition-all uppercase tracking-tight italic" x-text="item.name"></div>
                                            <div class="text-[10px] text-gray-600 font-mono mt-0.5 uppercase tracking-tighter opacity-50" x-text="item.sys"></div>
                                        </td>
                                        <td class="px-10 py-6 text-center text-4xl font-black text-white font-mono" x-text="item.count"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <div class="glass-card p-10 shadow-2xl border-white/5">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xs font-black uppercase tracking-[0.3em] text-gray-500 italic">Trend Analysis ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</h3>
                        </div>
                        <div style="height: 400px;"><canvas id="itemChart"></canvas></div>
                    </div>

                </section>
            </main>
        </div>
    </template>

    <script>
        function system() {
            return {
                currentPage: 'home',
                activeTab: '',
                search: '',
                passInput: '',
                rewardData: [],
                csvUrl: localStorage.getItem('rewardCsvUrl') || 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRFrdwnCKV_cB0AECX2p47917IPmwoamAqO5ubOz9wbyXMOLA5eiGnKVSIXrW5zEg0PLzMH5903mXtO/pub?gid=0&single=true&output=csv',
                chartInstance: null,
                async init() { await this.fetchData(); },
                doLogin() {
                    if (this.passInput === '123') { this.currentPage = 'admin'; this.passInput = ''; }
                    else { alert('Access Denied'); }
                },
                logout() { this.currentPage = 'home'; },
                saveUrl() {
                    localStorage.setItem('rewardCsvUrl', this.csvUrl);
                    location.reload();
                },
                async fetchData() {
                    try {
                        const res = await fetch(this.csvUrl + '&cb=' + Date.now());
                        const data = await res.text();
                        this.rewardData = this.parseCSV(data);
                        if (this.rewardData.length > 0) {
                            if (!this.activeTab) this.activeTab = this.rewardData[0].id;
                            this.$nextTick(() => this.renderChart());
                        }
                    } catch (e) { console.error(e); }
                },
                parseCSV(csv) {
                    const lines = csv.split(/\r?\n/).filter(l => l.trim() !== '');
                    const boxes = {};
                    lines.slice(1).forEach(line => {
                        const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                        if (cols.length < 5) return;
                        const [boxId, title, itemName, sysName, count] = cols.map(s => s.replace(/"/g, '').trim());
                        if (!boxes[boxId]) boxes[boxId] = { id: boxId, title: title, items: [], total: 0 };
                        const val = parseInt(count) || 0;
                        boxes[boxId].items.push({ name: itemName, sys: sysName, count: val });
                        boxes[boxId].total += val;
                    });
                    return Object.values(boxes);
                },
                getCurrentBox() { return this.rewardData.find(b => b.id === this.activeTab); },
                filteredItems() { 
                    const box = this.getCurrentBox();
                    return box ? box.items.filter(i => i.name.toLowerCase().includes(this.search.toLowerCase()) || i.sys.toLowerCase().includes(this.search.toLowerCase())) : [];
                },
                changeTab(id) { this.activeTab = id; this.$nextTick(() => this.renderChart()); },
                renderChart() {
                    const box = this.getCurrentBox();
                    if (!box) return;
                    const ctx = document.getElementById('itemChart').getContext('2d');
                    if (this.chartInstance) this.chartInstance.destroy();
                    
                    // [üî• ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Line Chart]
                    this.chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: box.items.map(i => i.name),
                            datasets: [{
                                data: box.items.map(i => i.count),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 4,
                                fill: true,
                                tension: 0.4, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô
                                pointBackgroundColor: '#fff',
                                pointBorderColor: '#3b82f6',
                                pointRadius: 6,
                                pointHoverRadius: 10
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#fff', font: { family: 'Kanit', size: 10, weight: 'bold' } } },
                                y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#475569', font: { size: 10 } } }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                }
            }
        }
    </script>
</body>
</html>
